name: drupal-codeception
recipe: drupal8

config:
  webroot: web
  php: 7.3
  via: apache:2.4
  database: mariadb
  xdebug: true

tooling:
  drush:
    service: appserver
    cmd: drush --root /app/web
  clean-install:
    service: appserver
    cmd: drush si --root /app/web --db-url mysql://drupal8:drupal8@database/drupal8 --account-pass supersecret standard  -y
  codecept:
    service: appserver
    description: Test runner.
    cmd: vendor/bin/codecept
  xdebug-on:
    service: appserver
    description: Enable xdebug for Apache.
    cmd: docker-php-ext-enable xdebug && service apache2 reload
    user: root
  xdebug-off:
    service: appserver
    description: Disable xdebug for Apache.
    cmd: rm /usr/local/etc/php/conf.d/docker-php-ext-xdebug.ini && service apache2 reload
    user: root

services:
  appserver:
    build_as_root:
      - curl -o /usr/local/share/ca-certificates/oneshoeCA.crt http://static.office.oneshoe.nl/ca.crt && update-ca-certificates
    build:
      - composer install
  chromedriver:
    type: compose
    services:
      image: robcherry/docker-chromedriver
      # See https://github.com/RobCherry/docker-chromedriver/issues/7
      privileged: true
      environment:
        # Override the container defaults to play nice with Codeception.
        CHROMEDRIVER_URL_BASE: "/wd/hub"
        CHROMEDRIVER_WHITELISTED_IPS: ""
      command: ["/usr/local/bin/supervisord", "-c", "/etc/supervisord.conf"]
